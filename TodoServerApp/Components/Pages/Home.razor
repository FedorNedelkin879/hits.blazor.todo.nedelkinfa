@page "/"
@rendermode InteractiveServer
@inject IDataService dataService
@inject NavigationManager navigationManager
@attribute [Authorize]

<PageTitle>Главная</PageTitle>

<div class="container-fluid mt-5">
    <div class="mb-5">
        <h1 class="display-4 text-dark">Товарный учёт</h1>
        <p class="lead text-secondary">Добро пожаловать в систему управления товарами</p>
    </div>

    @if (isLoading)
    {
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Загрузка данных...</span>
        </div>
    }
    else
    {
        <!-- КЛЮЧЕВЫЕ МЕТРИКИ -->
        <div class="row mb-5">
            <div class="col-md-3 mb-4">
                <div class="card border-secondary shadow-sm h-100">
                    <div class="card-header bg-dark text-white">
                        <p class="mb-0 small">Всего товаров</p>
                    </div>
                    <div class="card-body text-center">
                        <h2 class="display-5 text-primary">@totalProducts</h2>
                    </div>
                    <div class="card-footer bg-light border-secondary">
                        <a href="products" class="btn btn-sm btn-primary w-100">Перейти</a>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-4">
                <div class="card border-secondary shadow-sm h-100">
                    <div class="card-header bg-dark text-white">
                        <p class="mb-0 small">Общая стоимость</p>
                    </div>
                    <div class="card-body text-center">
                        <h2 class="text-primary">@totalValue.ToString("C")</h2>
                    </div>
                    <div class="card-footer bg-light border-secondary">
                        <a href="reports" class="btn btn-sm btn-primary w-100">Отчёты</a>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-4">
                <div class="card border-secondary shadow-sm h-100">
                    <div class="card-header bg-dark text-white">
                        <p class="mb-0 small">Сотрудников</p>
                    </div>
                    <div class="card-body text-center">
                        <h2 class="display-5 text-primary">@totalEmployees</h2>
                    </div>
                    <div class="card-footer bg-light border-secondary">
                        <a href="employees" class="btn btn-sm btn-primary w-100">Перейти</a>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-4">
                <div class="card border-secondary shadow-sm h-100">
                    <div class="card-header bg-dark text-white">
                        <p class="mb-0 small">Операций</p>
                    </div>
                    <div class="card-body text-center">
                        <h2 class="display-5 text-primary">@totalOperations</h2>
                    </div>
                    <div class="card-footer bg-light border-secondary">
                        <a href="operations" class="btn btn-sm btn-primary w-100">Перейти</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- КРИТИЧЕСКИЕ ОСТАТКИ -->
        <div class="row mb-5">
            <div class="col-lg-6">
                <div class="card border-secondary shadow-sm">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">Товары с критическими остатками</h5>
                    </div>
                    <div class="card-body">
                        @if (lowStockItems.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Товар</th>
                                            <th>Остаток</th>
                                            <th>Статус</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in lowStockItems.Take(5))
                                        {
                                            <tr>
                                                <td>@item.ProductName</td>
                                                <td>
                                                    <strong>@item.CurrentStock шт.</strong>
                                                </td>
                                                <td>
                                                    @if (item.CurrentStock == 0)
                                                    {
                                                        <span class="badge bg-danger">Нет</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-warning text-dark">Мало</span>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-info mb-0">
                                Все товары в норме
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- ПОСЛЕДНИЕ ОПЕРАЦИИ -->
            <div class="col-lg-6">
                <div class="card border-secondary shadow-sm">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">Последние операции</h5>
                    </div>
                    <div class="card-body">
                        @if (recentOperations.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Дата</th>
                                            <th>Товар</th>
                                            <th>Тип</th>
                                            <th>Кол-во</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var op in recentOperations.Take(5))
                                        {
                                            <tr>
                                                <td>@op.OperationDate.ToString("dd.MM HH:mm")</td>
                                                <td>@op.Product?.Name</td>
                                                <td>
                                                    <span class="badge @GetOpTypeBadge(op.Type)">
                                                        @op.Type.ToString()
                                                    </span>
                                                </td>
                                                <td>@op.Quantity шт.</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-info mb-0">
                                Нет операций
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- БЫСТРЫЕ ДЕЙСТВИЯ -->
        <div class="row">
            <div class="col-12">
                <h5 class="text-dark mb-3">Быстрые действия</h5>
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-primary" @onclick='() => navigationManager.NavigateTo("products/add")'>
                        Добавить товар
                    </button>
                    <button class="btn btn-primary" @onclick='() => navigationManager.NavigateTo("employees/add")'>
                        Добавить сотрудника
                    </button>
                    <button class="btn btn-primary" @onclick='() => navigationManager.NavigateTo("operations/add")'>
                        Создать операцию
                    </button>
                    <button class="btn btn-primary" @onclick='() => navigationManager.NavigateTo("reports")'>
                        Посмотреть отчёты
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool isLoading = true;
    private int totalProducts;
    private decimal totalValue;
    private int totalEmployees;
    private int totalOperations;
    private List<ProductStockReport> lowStockItems = [];
    private List<Operation> recentOperations = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
        isLoading = false;
    }

    private async Task LoadDashboardData()
    {
        try
        {
            // Товары
            var products = await dataService.GetAllProductsAsync();
            totalProducts = products.Count();

            // Стоимость
            var stockReport = await dataService.GetStockReportAsync();
            totalValue = stockReport.Sum(r => r.TotalValue);
            lowStockItems = stockReport.Where(r => r.CurrentStock <= 10).OrderBy(r => r.CurrentStock).ToList();

            // Сотрудники
            var employees = await dataService.GetAllEmployeesAsync();
            totalEmployees = employees.Count();

            // Операции
            var operations = await dataService.GetAllOperationsAsync();
            totalOperations = operations.Count();
            recentOperations = operations.Take(10).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка загрузки данных: {ex.Message}");
        }
    }

    private string GetOpTypeBadge(OperationType type)
    {
        return type switch
        {
            OperationType.Приход => "bg-success",
            OperationType.Продажа => "bg-info",
            OperationType.Списание => "bg-danger",
            _ => "bg-secondary"
        };
    }
}
