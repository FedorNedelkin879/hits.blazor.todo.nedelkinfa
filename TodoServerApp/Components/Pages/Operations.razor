@page "/operations"
@rendermode InteractiveServer
@inject IDataService dataService
@inject NavigationManager navigationManager
@attribute [Authorize]

<PageTitle>Операции</PageTitle>

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-dark">Операции с товарами</h1>
        <button class="btn btn-primary" @onclick="AddOperation">Новая операция</button>
    </div>

    @if (operations == null)
    {
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Загрузка...</span>
        </div>
    }
    else if (operations.Count == 0)
    {
        <div class="alert alert-info">Нет операций. Добавьте первую операцию!</div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-hover border-secondary">
                <thead class="table-dark">
                    <tr>
                        <th>Дата</th>
                        <th>Тип</th>
                        <th>Товар</th>
                        <th>Количество</th>
                        <th>Сотрудник</th>
                        <th>Примечание</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var op in operations)
                    {
                        <tr>
                            <td>@op.OperationDate.ToString("dd.MM.yyyy HH:mm")</td>
                            <td>
                                <span class="badge @GetOperationBadge(op.Type)">
                                    @op.Type.ToString()
                                </span>
                            </td>
                            <td>@op.Product?.Name</td>
                            <td>
                                <strong>@op.Quantity шт.</strong>
                            </td>
                            <td>@op.Employee?.Name</td>
                            <td>@op.Notes</td>
                            <td>
                                <button class="btn btn-sm btn-outline-danger" @onclick="async () => await DeleteOperation(op.Id)">Удалить</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private List<Operation>? operations;

    protected override async Task OnInitializedAsync()
    {
        await LoadOperations();
    }

    private async Task LoadOperations()
    {
        operations = (await dataService.GetAllOperationsAsync()).ToList();
    }

    private void AddOperation()
    {
        navigationManager.NavigateTo("operations/add");
    }

    private async Task DeleteOperation(int id)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "Вы уверены?"))
        {
            await dataService.DeleteOperationAsync(id);
            await LoadOperations();
        }
    }

    private string GetOperationBadge(OperationType type)
    {
        return type switch
        {
            OperationType.Приход => "bg-success",
            OperationType.Продажа => "bg-info",
            OperationType.Списание => "bg-danger",
            _ => "bg-secondary"
        };
    }

    @inject IJSRuntime JSRuntime;
}
