@page "/products/add"
@page "/products/{Id:int}"
@rendermode InteractiveServer
@inject IDataService dataService
@inject NavigationManager navigationManager
@attribute [Authorize]

<PageTitle>@(Id == 0 ? "Новый товар" : "Редактирование товара")</PageTitle>

<div class="container mt-5">
    <div class="row">
        <div class="col-md-6 offset-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h3 class="mb-0">@(Id == 0 ? "Добавить товар" : "Редактировать товар")</h3>
                </div>

                <div class="card-body">
                    @if (product != null)
                    {
                        <EditForm Model="product" FormName="ProductForm" OnValidSubmit="SaveProduct">
                            <DataAnnotationsValidator />
                            <ValidationSummary class="alert alert-danger" />

                            <div class="mb-3">
                                <label class="form-label">Название товара</label>
                                <InputText @bind-Value="product.Name" class="form-control border-secondary" />
                                <ValidationMessage For="() => product.Name" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label">SKU (артикул)</label>
                                <InputText @bind-Value="product.SKU" class="form-control border-secondary" />
                                <ValidationMessage For="() => product.SKU" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Категория</label>
                                <InputSelect @bind-Value="product.Category" class="form-select border-secondary">
                                    <option value="">Выберите категорию</option>
                                    <option value="Молочные продукты">Молочные продукты</option>
                                    <option value="Хлебопекарня">Хлебопекарня</option>
                                    <option value="Птицеводство">Птицеводство</option>
                                    <option value="Напитки">Напитки</option>
                                    <option value="Снеки">Снеки</option>
                                    <option value="Другое">Другое</option>
                                </InputSelect>
                                <ValidationMessage For="() => product.Category" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Цена (руб.)</label>
                                <InputNumber @bind-Value="product.Price" class="form-control border-secondary" />
                                <ValidationMessage For="() => product.Price" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Остаток (шт.)</label>
                                <InputNumber @bind-Value="product.Stock" class="form-control border-secondary" />
                                <ValidationMessage For="() => product.Stock" />
                            </div>

                            <div class="d-flex gap-2 pt-3">
                                <button type="submit" class="btn btn-primary">Сохранить</button>
                                <a href="products" class="btn btn-secondary">Отмена</a>
                            </div>
                        </EditForm>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    [SupplyParameterFromForm]
    private Product? product { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (product == null)
        {
            product = new();
            if (Id != 0)
            {
                var existing = await dataService.GetProductAsync(Id);
                product.Id = existing.Id;
                product.Name = existing.Name;
                product.SKU = existing.SKU;
                product.Category = existing.Category;
                product.Price = existing.Price;
                product.Stock = existing.Stock;
                product.CreatedDate = existing.CreatedDate;
            }
        }
    }

    private async Task SaveProduct()
    {
        await dataService.SaveProductAsync(product!);
        navigationManager.NavigateTo("products");
    }
}
